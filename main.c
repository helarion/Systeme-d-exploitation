#include <stdio.h> 
#include <stdlib.h> 
#include <pthread.h> 
#include <string.h>
#include <semaphore.h> 
#include <unistd.h> 
#include <sys/ipc.h> 
#include <sys/shm.h>
#include <sys/types.h>

int allouerSegmentPartage(size_t taille, char* chemin){

	int id=666;
	int idSegment;
	///// génère clef d'identification du segment /////
	key_t clef = ftok(chemin,id);
	///// génère le sgment de mémoire partagée //////
	idSegment=shmget(clef,taille,0666 | IPC_CREAT);
	
	return idSegment;
}

void detruireSegmentPartage( int idSegment){

	 shmctl(idSegment, IPC_RMID,0);
}

void informationSegment( int idSegment){

	struct shmid_ds watch;
	shmctl(idSegment, IPC_STAT,&watch);

	printf("permissions d'accès : %d",watch.shm_perm.mode);
	printf("taille : %d", (int) watch.shm_segsz);
	printf("date dernier accès : %d", (int) watch.shm_atime);
	printf("date dernier liberation : %d", (int) watch.shm_dtime);
	printf("date dernier changement : %d", (int) watch.shm_ctime);
	printf("PID du créateur : %d" ,(int) watch.shm_cpid);
	printf("Nombre courant d'accès au segment : %d", (int) watch.shm_nattch);
}

int main()
{

	int pid; char *mem; int shmid; int flag=0;
	char *name = "TP2.cpp";

	/*Creer le segment partage*/
	shmid = allouerSegmentPartage(100,name);
	sem_t semaphore;
	sem_init(&semaphore,0,1);

	switch(pid=fork()) {
		case -1:
		fprintf(stderr,"Where are you, Luke ?");
		return -1;

		case 0:
		printf("My name is Luke %d\n",getpid());
		mem = shmat(shmid,0,flag);
		if(mem==(char*)-1) {
		printf("Attachement impossible");
		exit(1);
		}

		strcpy(mem,"Anakin, I am your son.");
		if(shmdt(mem)==-1) {
			fprintf(stderr,"Detachement impossible");
			exit(1);
		}
		sem_post(&semaphore);
		return 0;

		default:
		sem_wait(&semaphore);
		printf("I am the father.");
		mem = shmat(shmid,0,flag);
		if(mem ==(char*)-1) {
			fprintf(stderr, "Attachement impossible");
			exit(1);
		}

		printf("Luke a ecrit :\n%s\n",mem);
			if(shmdt(mem)==-1) {
				fprintf(stderr, "Detachement impossible");
				exit(1);
			}

	}

	/*Le pere attend la mort du processus fils*/
	wait(0);

	/*Detruire le segment partage*/
	detruireSegmentPartage(shmid) ;

	return 0;
}
