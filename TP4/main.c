#include <time.h>
#include <stdio.h> 
#include <stdlib.h> 
#include <pthread.h> 
#include <string.h>
#include <semaphore.h> 
#include <stdbool.h>
#include <unistd.h> 
#include <sys/ipc.h> 
#include <sys/shm.h>
#include <sys/types.h>
#include <sys/wait.h>

//typedef int bool

int allouerSegmentPartage(size_t taille, char* chemin){

	int id=666;
	int idSegment;
	///// génère clef d'identification du segment /////
	key_t clef = ftok(chemin,id);
	///// génère le sgment de mémoire partagée //////
	idSegment=shmget(clef,taille,0666 | IPC_CREAT);
	
	return idSegment;
}

void detruireSegmentPartage( int idSegment){

	 shmctl(idSegment, IPC_RMID,0);
}

void informationSegment( int idSegment){

	struct shmid_ds watch;
	shmctl(idSegment, IPC_STAT,&watch);

	printf("permissions d'accès : %d",watch.shm_perm.mode);
	printf("taille : %d", (int) watch.shm_segsz);
	printf("date dernier accès : %d", (int) watch.shm_atime);
	printf("date dernier liberation : %d", (int) watch.shm_dtime);
	printf("date dernier changement : %d", (int) watch.shm_ctime);
	printf("PID du créateur : %d" ,(int) watch.shm_cpid);
	printf("Nombre courant d'accès au segment : %d", (int) watch.shm_nattch);
}

void initialisation(char grille[10][10]) {
	int i,j;
	for(i=0;i<10;i++)
	{
		for(j=0;j<10;j++)
		{
			grille[i][j]='.';
		}
	}
}

void placement(char grille[10][10]) {
	int i,j,x,y;
	int xRand,yRand;
	for(i=5;i>1;i--)
	{
		bool random=false;
		while(random==false)
		{
			srand(time(NULL));
			int c=0;
			xRand=rand() % 10;
			yRand=rand() % 10;
			int vX,vY;
			bool poser=false;
			while(poser==false && c<4)
			{
				bool test=true;
				switch(c)
				{
					case 0: 
						vX=1;
						vY=0;
						break;
					case 1:
						vX=0;
						vY=1;
						break;
					case 2:
						vX=-1;
						vY=0;
						break;
					case 3:
						vX=0;
						vY=-1;
						break;
				}
				for(j=0;j<i;j++)
				{
					x=xRand+(vX*j);
					y=yRand+(vY*j);
					if(x>9||x<0||y>9||y<0)
					{
						test=false;
						break;
					}
					else if(grille[x][y]!='.') test=false;
				}
				if(test==true)
				{
					poser=true;
					for(j=0;j<i;j++)
					{
						x=xRand+(vX*j);
						y=yRand+(vY*j);
						grille[x][y]='B';
					}
				}
				c++;
			}
			if(poser==true) random=true;
		}
	}
}

void tirer(char grille[10][10])
{
	int x,y;
	printf("Entrez les coordonnées de votre tir:\n");
	printf("X:");
	scanf("%d",&x);
	printf("Y:");
	scanf("%d",&y);
	if(grille[x][y]=='B') grille[x][y]='C';
	else if(grille[x][y]=='.') grille[x][y]='R';
}

void afficherGrille(char grille[10][10])
{
	int i,j;
	for(i=0;i<10;i++)
	{
		for(j=0;j<10;j++)
		{
			printf("%c",grille[i][j]);
		}
		printf("\n");
	}	
	printf("\n");
}

void joueur1(int grille[10][10])
{
		// tour du joueur 1
	while(fin==false)
	{
		sem_wait(&S1);
		afficherGrille(grille2); 
		tirer(grille2);
		afficherGrille(grille2); 
		sem_post(&S0);
	}
}

void joueur1(int grille[10][10])
{
	// tour du joueur 2
	while(fin==false)
	{
		sem_wait(&S0);
		afficherGrille(grille1); 
		tirer(grille1);
		afficherGrille(grille1); 
		sem_post(&S1);
	}
}

int main()
{
	int pid; char *mem; int shmid; int flag=0;
	char *name = "batailleNavale";

	/*Creer le segment partage*/
	shmid = allouerSegmentPartage(100,name);
	
	// sémaphores

	sem_t *S0 = sem_open("S0", O_CREAT, 0660,0); // joueur 2
	sem_t *S1 = sem_open("S1", O_CREAT, 0660,1); // joueur 1
	sem_t *S2 = sem_open("S2", O_CREAT, 0660,2); // nombre de joueur
	sem_unlink("S0");
	sem_unlink("S1");
	sem_unlink("S2");
	/*sem_init(&S0,0,0); // joueur 2
	sem_init(&S1,0,1); // joueur 1
	sem_init(&S2,0,2); // nombre de joueurs*/
	
	char grille1[10][10];
	char grille2[10][10];
	
	initialisation(grille1);
	initialisation(grille2);
	placement(grille1);
	placement(grille2);

	/*Detruire le segment partage*/
	detruireSegmentPartage(shmid) ;

	return 0;
}
